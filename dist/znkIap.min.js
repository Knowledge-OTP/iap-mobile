!function(a){"use strict";a.module("znk.iap",[])}(angular),function(a){"use strict";a.module("znk.iap").factory("InAppPurchaseHelperSrv",["$q","$rootScope","$injector","ENV",function(b,c,d,e){var f={},g="iap";return f.getProducts=function(){var a=d.get("StorageSrv");return a.get(g).then(function(a){return a.products&&a.products[e.firebaseAppScopeName]&&a.products[e.firebaseAppScopeName].length?a.products[e.firebaseAppScopeName]:(console.error("Failed to retrieve products from db"),b.reject("Failed to retrieve products from db"))})},f.getUserSubscription=function(){var a=d.get("StorageSrv"),b=a.globalUserSpacePath.concat(["subscriptions"]);a.get(b).then(function(a){return a.sat?new Date(a.sat):null})},f.updateSubscription=function(b){return a.isUndefined(b)?void 0:f.getUserSubscription().then(function(a){var c=d.get("StorageSrv"),e=c.globalUserSpacePath.concat(["subscriptions"]);a.sat=b.getTime(),c.set(e,a)})},f.validateReceipt=function(){return b.when(!0)},f.addTransaction=function(c){var e=c.transaction.id?c.transaction.id.replace(".",""):(new Date).getTime();for(var g in c.transaction)(a.isUndefined(c.transaction[g])||null===c.transaction[g])&&delete c.transaction[g];c.purchaseTime=(new Date).getTime();var h=d.get("StorageSrv"),i=h.globalUserSpacePath.concat(["transactions"]);return h.get(i).then(function(a){if(a[e])return b.when(null);a[e]=c,h.set(i,a);var d=f.getProductLength(c.id);return d.then(function(a){if(!a)return null;var b=new Date;return b.setMonth(b.getMonth()+a),f.updateSubscription(b),b})})},f.getProductLength=function(a){var b=f.getProducts();return b.then(function(b){for(var c in b){var d=b[c];if(d.appStoreId===a||d.playStoreUid===a)return d.length}return null})},f}])}(angular),function(a,b){"use strict";a.module("znk.iap").provider("IapSrv",function(){var c;this.setAvailProductsFallback=function(a){c=a},this.$get=["$window","$q","$injector","$rootScope","$filter","InAppPurchaseHelperSrv","ENV","$analytics",function(d,e,f,g,h,i,j,k){function l(){q=!1}function m(){q=!0}c||console.error("fallback products were not set for iap");var n,o=[],p=[],q=!(!d.navigator||!d.navigator.onLine),r=e.defer(),s="iap:subscribed",t={_products:[],SUBSCRIPTION_PURCHASED_EVENT:s,subscriptionLengthInMonth:{}};return t.init=function(){var a=i.getProducts();a["catch"](function(){return c}).then(function(a){return a.forEach(function(a){var c,d;if(b.Platform.isAndroid()&&a.playStoreUid&&(c=a.playStoreUid,d=a.playStoreType),b.Platform.isIOS()&&a.appStoreId&&(c=a.appStoreId,d=a.appStoreType),c){var e;e=c.indexOf(".m")>-1?c.substr(c.lastIndexOf("sub")).substr(0,c.substr(c.lastIndexOf("sub")).lastIndexOf(".")):c.substr(c.lastIndexOf(".")+1),o.push(c),p.push({id:c,type:d,alias:e}),t.subscriptionLengthInMonth[c]=a.length}}),t.productIds=o,p}).then(function(a){function b(a){var b=t.productIds.indexOf(a.id);if(-1===b)throw"Unrecognized product id was received !!!!! "+a.id;t._products[b]=a}n=d.store,n.verbosity=j.debug?n.DEBUG:n.QUIET,n.validator=function(a,b){var c=i.validateReceipt(a.transaction.appStoreReceipt);c.then(function(a){b(a)})},a.forEach(function(a){n.get(a.alias)||n.register({id:a.id,alias:a.alias,type:a.type})}),n.when("product").updated(function(a){b(a)}),n.error(function(a){k.eventTrack("store-error",{category:"purchase",label:a}),r.resolve||r.reject("Store Not Available")}),n.ready(function(){r.resolved=!0,r.resolve(!0)})})},t.noStore=function(a){a||(a="No store available"),r.reject(a)},t.getSubscription=function(){return i.getUserSubscription().then(function(a){if(!a)return null;var b=new Date;return b.setDate(b.getDate()-1),b>a?null:a})},t.purchase=function(a){function b(a){console.log("cancelled"),k.eventTrack("cancel-purchase",{category:"purchase",label:"cancelled"}),l.reject(a)}function c(b){if(console.log("finished"),k.eventTrack("purchased",{category:"purchase",label:"purchased"}),d.facebookConnectPlugin&&d.facebookConnectPlugin.logEvent("Purchased",{NumItems:1,Currency:"USD",ContentType:"zinkerzsat",ContentID:a},null,function(){},function(){}),d.plugins&&d.plugins.matPlugin){var c={name:"purchase",revenue:1,currency:"USD",advertiserRefId:"182516"};d.plugins.matPlugin.measureEvent(c)}l.resolve(b)}function f(a){console.log("approved"),k.eventTrack("purchase-approved",{category:"purchase",label:"approved"}),a.verify()}function h(a){console.log("verified"),k.eventTrack("purchase-verified",{category:"purchase",label:"verified"});var b=i.addTransaction(a);b.then(function(b){b&&(a.finish(),g.$broadcast(s,b))})}function j(){console.log("unverified"),k.eventTrack("purchase-unverified",{category:"purchase",label:"unverified"})}var l=e.defer(),m=d.store.order(a);return m.then(function(){d.store.when(a).cancelled(b),d.store.when(a).finished(c),d.store.when(a).approved(f),d.store.when(a).verified(h),d.store.when(a).unverified(j)}),m.error(function(a){l.reject(a)}),l.promise["finally"](function(){d.store.off(b),d.store.off(c),d.store.off(f),d.store.off(h),d.store.off(j)}),l.promise},t.getProducts=function(){if(!q){var b=e.defer();return b.reject("No Internet connection"),b.promise}return t._products.length||d.store.refresh(),r.promise.then(function(){return a.copy(t._products)},function(a){throw a})},document.addEventListener("offline",l,!1),document.addEventListener("online",m,!1),t}]})}(angular,ionic);