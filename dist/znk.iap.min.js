!function(a){"use strict";a.module("znk.iap",["ionic"])}(angular),function(a){"use strict";a.module("znk.iap").factory("InAppPurchaseHelperSrv",["$q","$rootScope","$injector","ENV",function(b,c,d,e){var f={},g="iap",h=e.firebaseAppScopeName;return f.getProducts=function(){var a=d.get("StorageSrv");return a.get(g).then(function(a){return a.products&&a.products[h]&&a.products[h].length?a.products[h]:(console.error("Failed to retrieve products from db"),b.reject("Failed to retrieve products from db"))})},f.getUserSubscription=function(){var a=d.get("StorageSrv"),b=a.globalUserSpacePath.concat(["subscriptions"]);return a.get(b).then(function(a){return a[h]?new Date(a[h]):null})},f.updateSubscription=function(b){if(!a.isUndefined(b)){var c=d.get("StorageSrv"),e=c.globalUserSpacePath.concat(["subscriptions"]);return c.get(e).then(function(a){a[h]=b.getTime(),c.set(e,a)})}},f.validateReceipt=function(){return b.when(!0)},f.addTransaction=function(c){var e=c.transaction.id?c.transaction.id.replace(".",""):(new Date).getTime();for(var g in c.transaction)(a.isUndefined(c.transaction[g])||null===c.transaction[g])&&delete c.transaction[g];c.purchaseTime=(new Date).getTime();var h=d.get("StorageSrv"),i=h.globalUserSpacePath.concat(["transactions"]);return h.get(i).then(function(a){if(a[e])return b.when(null);a[e]=c,h.set(i,a);var d=f.getProductLength(c.id);return d.then(function(a){if(!a)return null;var b=new Date;return b.setMonth(b.getMonth()+a),f.updateSubscription(b),b})})},f.getProductLength=function(a){var b=f.getProducts();return b.then(function(b){for(var c in b){var d=b[c];if(d.appStoreId===a||d.playStoreUid===a)return d.length}return null})},f}])}(angular),function(a){"use strict";a.module("znk.iap").provider("IapSrv",[function(){var b,c,d,e,f=!1;this.registerProducts=function(a){b=a},this.setValidator=function(a){c=a},this.setNoStoreMode=function(a){d=a,console.log("IAP EnableNoStoreMode: "+d)},this.setEnableRecipetValidation=function(a){f=a},this.setValidationUrl=function(a){e=a},this.$get=["$window","$q","$injector","$filter","InAppPurchaseHelperSrv","ENV","$analytics","$ionicLoading","$ionicPopup","$document","$timeout","$http",function(g,h,i,j,k,l,m,n,o,p,q,r){function s(a){return a&&a.title&&a.price?!0:!1}function t(a){var b,c=x(a.type);if(c===I.UNKNOWN)return h.reject("unknown platform");switch(c){case"apple":b={appleReceipt:a.appStoreReceipt};break;case"google":b={signature:a.signature,receiptData:a.receipt}}return r.post(e+"verify/"+c,{transaction:a}).then(function(a){return a},function(a){return h.reject(a)})}function u(){return F||(F=i.invoke(c)),F}function v(){return console.log("_getAppProducts"),i.invoke(b)}function w(){return console.log("init app products for the store"),v()}function x(b){switch(a.lowercase(b)){case"ios-appstore":return"apple";case"android-playstore":return"google";default:return I.UNKNOWN}}function y(){console.log("not online"),G=!1}function z(){console.log("online"),G=!0}var A=!g.cordova,B=h.defer(),C=B.promise,D=!1,E=q(function(){D=!0,a.isDefined(B)&&B.reject("store timeout")},15e3);(d||A)&&(D||(q.cancel(E),B.resolve()));var F,G=!(!g.navigator||!g.navigator.onLine),H={transaction:{id:"demo"},price:"$30.99",title:"buy"},I={IOS:0,ANDROID:1,UNKNOWN:2},J={initializedStore:!1,products:{},appProductsArr:[],isPurchaseInProgress:!1,purchaseInProgressDfd:void 0,IapErrorCodeEnum:{CANCELLED:0,FAILED:1,VALIDATOR_FALSE:2,VALIDATOR_ERROR:3,VALIDATOR_NO_TRANSACTION:4,RECIPT_NOT_APPROVED:5}};return J.getAppProduct=function(a){for(var b=0;b<J.appProductsArr.length;b++)if(J.appProductsArr[b].id===a)return J.appProductsArr[b]},J.getStoreProduct=function(a){return C.then(function(){return s(J.products[a])?J.products[a]:null})},J.getStoreProducts=function(){return C.then(function(){var b=[];if(d||A)J.appProductsArr.forEach(function(c){var d={};H.title=c.id.replace("com.zinkerz.zinkerztoefl.",""),a.extend(d,c,H),b.push(a.copy(d))});else for(var c in J.products)s(J.products[c])&&b.push(a.copy(J.products[c]));return b})},J.getIapStoreReadyPromise=function(){return C},J.purchase=function(b){return console.log("starting purchase"),C.then(function(){if(console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress),J.isPurchaseInProgress)return console.log("purchase is already in progress"),h.reject(!1);if(J.isPurchaseInProgress=!0,J.purchaseInProgressDfd=h.defer(),n.show({template:"Purchase is in progress..."}),d||A){var c=u(),e={},f=J.getAppProduct(b);return a.extend(e,f,H),c(e).then(function(a){a?(console.log("mock purchase completed"),J.purchaseInProgressDfd.resolve(f),J.isPurchaseInProgress=!1,n.hide(),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress)):(console.log("error in validating mock purchase"),J.purchaseInProgressDfd.reject(),J.isPurchaseInProgress=!1,n.hide(),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress))})["catch"](function(a){console.log("error in mock purchase, err: "+a),J.purchaseInProgressDfd.reject(a),J.isPurchaseInProgress=!1,n.hide(),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress)}),J.purchaseInProgressDfd.promise}var i=J.products[b];return i?g.store.order(i.id).error(function(a){console.log("error in purchase, store.order, err:"+a),m.eventTrack("store-order-error",{category:"purchase",label:a}),J.purchaseInProgressDfd.reject(a),J.isPurchaseInProgress=!1,n.hide(),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress)}):(console.log("error in purchase, no product"),J.purchaseInProgressDfd.reject(),J.isPurchaseInProgress=!1,n.hide(),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress)),J.purchaseInProgressDfd.promise})},J.initStore=function(){if(d||A)return void w().then(function(b){a.isArray(b)&&b.length>0?(J.appProductsArr=b,console.log("app products loaded")):console.error("failed to load app products")})["catch"](function(a){console.error("failed to load app products, err:"+a)});if(!g.store)return console.log("store is not available"),void(a.isDefined(B)&&(D||B.reject()));console.log("initializing store"),f&&(a.isString(e)&&0!==e.length||D||B.reject());var b=w();b["catch"](function(b){console.error("failed to load app products, err:"+b),a.isDefined(B)&&(D||B.reject(b))}),b.then(function(b){if(!(a.isArray(b)&&b.length>0))return console.error("failed to load app products"),void(a.isDefined(B)&&(D||B.reject()));if(J.appProductsArr=b,console.log("app products loaded"),!J.initializedStore){J.initializedStore=!0,g.store.verbosity=l.debug?g.store.DEBUG:g.store.QUIET,g.store.validator=function(a,b){console.log("performing validator");var c;a.transaction?(console.log("new transaction, transaction:"+JSON.stringify(a.transaction)),f?(console.log("enableRecipetValidation is true"),c=t(a.transaction)):c=h.when(!0),c.then(function(a){console.log("verifyRecieptProm returned "+a),a&&a.data&&a.data.ok?b(!0,a.data.data):b(!1,{error:{code:J.IapErrorCodeEnum.RECIPT_NOT_APPROVED,message:"recipt not approved"}})})["catch"](function(a){console.error("error in verifyRecieptProm validator: "+a),b(!1,{error:{code:J.IapErrorCodeEnum.VALIDATOR_ERROR,message:a}})})):(console.log("no transaction in validator"),b(!1,{error:{code:J.IapErrorCodeEnum.VALIDATOR_NO_TRANSACTION,message:"no transaction"}}))},J.appProductsArr.forEach(function(a){console.log("registering product: "+JSON.stringify(a)),g.store.register({id:a.id,alias:a.alias,type:a.type})});var c=function(a){console.log("purchase approved"),m.eventTrack("purchase-approved",{category:"purchase",label:"approved"}),a.verify()};J.appProductsArr.forEach(function(a){g.store.when(a.id).approved(function(a){c(a)})}),J.appProductsArr.forEach(function(b){g.store.when(b.id).verified(function(b){console.log("purchase verified"),m.eventTrack("purchase-recipt-verified",{category:"purchase",label:"verified"});var c=u();a.isFunction(c)?c(b).then(function(c){n.hide(),c?(console.log("app validator returned true"),a.isDefined(J.purchaseInProgressDfd)&&J.purchaseInProgressDfd.resolve(b),J.isPurchaseInProgress=!1,n.hide(),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress),b.finish()):(console.error("app validator returned false"),a.isDefined(J.purchaseInProgressDfd)&&J.purchaseInProgressDfd.reject(!1),J.isPurchaseInProgress=!1,n.hide(),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress))})["catch"](function(b){console.error("error in app validator: "+b),m.eventTrack("store-validator-error",{category:"purchase",label:b}),a.isDefined(J.purchaseInProgressDfd)&&J.purchaseInProgressDfd.reject(b),J.isPurchaseInProgress=!1,n.hide(),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress)}):(console.error("_getValidatorFunc returned no function"),a.isDefined(J.purchaseInProgressDfd)&&J.purchaseInProgressDfd.reject(!1),J.isPurchaseInProgress=!1,n.hide(),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress))})}),J.appProductsArr.forEach(function(b){g.store.when(b.id).unverified(function(){console.log("purchase unverified"),m.eventTrack("purchase-unverified",{category:"purchase",label:"unverified"}),console.error("store recipt no validated"),a.isDefined(J.purchaseInProgressDfd)&&J.purchaseInProgressDfd.reject(),J.isPurchaseInProgress=!1,n.hide(),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress)})}),J.appProductsArr.forEach(function(a){g.store.when(a.id).initiated(function(){console.log("purchase initiated...")})});var d=function(){console.log("purchase cancelled"),m.eventTrack("cancel-purchase",{category:"purchase",label:"cancelled"}),a.isDefined(J.purchaseInProgressDfd)&&J.purchaseInProgressDfd.reject({code:J.IapErrorCodeEnum.CANCELLED,message:"purchase cancelled"}),J.isPurchaseInProgress=!1,n.hide(),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress)};J.appProductsArr.forEach(function(a){g.store.when(a.id).cancelled(function(a){d(a)}),g.store.when(a.id).refunded(function(a){console.log("purchase refunded, product:"+a.id)})}),g.store.ready(function(){console.log("-----store is ready-----"),D||(q.cancel(E),a.isDefined(B)&&B.resolve())}),J.appProductsArr.forEach(function(a){g.store.when(a.id).updated(function(a){console.log("product updated: "+a.id),J.products[a.id]=a}),g.store.when(a.id).finished(function(a){console.log("product finished: "+a.id),m.eventTrack("purchased",{category:"purchase",label:a.id}),m.pageTrack("product-purchased/"+a.id)})}),g.store.error(function(b){console.log("store-error "+b.code+": "+b.message),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress),m.eventTrack("store-error",{category:"purchase",label:b}),a.isDefined(J.purchaseInProgressDfd)&&J.purchaseInProgressDfd.reject(b),J.isPurchaseInProgress=!1,n.hide(),console.log("purchase: isPurchaseInProgress="+J.isPurchaseInProgress),a.isDefined(B)&&(D||B.reject(b))}),g.store.refresh()}})["catch"](function(b){a.isDefined(B)&&(D||B.reject(b)),console.error("failed to init store products, err="+b)})},document.addEventListener("offline",y,!1),document.addEventListener("online",z,!1),q(function(){J.initStore()},0),J}]}])}(angular);