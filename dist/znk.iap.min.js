!function(a){"use strict";a.module("znk.iap",["ionic"])}(angular),function(a){"use strict";a.module("znk.iap").factory("InAppPurchaseHelperSrv",["$q","$rootScope","$injector","ENV",function(b,c,d,e){var f={},g="iap",h=e.firebaseAppScopeName;return f.getProducts=function(){var a=d.get("StorageSrv");return a.get(g).then(function(a){return a.products&&a.products[h]&&a.products[h].length?a.products[h]:(console.error("Failed to retrieve products from db"),b.reject("Failed to retrieve products from db"))})},f.getUserSubscription=function(){var a=d.get("StorageSrv"),b=a.globalUserSpacePath.concat(["subscriptions"]);return a.get(b).then(function(a){return a[h]?new Date(a[h]):null})},f.updateSubscription=function(b){if(!a.isUndefined(b)){var c=d.get("StorageSrv"),e=c.globalUserSpacePath.concat(["subscriptions"]);return c.get(e).then(function(a){a[h]=b.getTime(),c.set(e,a)})}},f.validateReceipt=function(){return b.when(!0)},f.addTransaction=function(c){var e=c.transaction.id?c.transaction.id.replace(".",""):(new Date).getTime();for(var g in c.transaction)(a.isUndefined(c.transaction[g])||null===c.transaction[g])&&delete c.transaction[g];c.purchaseTime=(new Date).getTime();var h=d.get("StorageSrv"),i=h.globalUserSpacePath.concat(["transactions"]);return h.get(i).then(function(a){if(a[e])return b.when(null);a[e]=c,h.set(i,a);var d=f.getProductLength(c.id);return d.then(function(a){if(!a)return null;var b=new Date;return b.setMonth(b.getMonth()+a),f.updateSubscription(b),b})})},f.getProductLength=function(a){var b=f.getProducts();return b.then(function(b){for(var c in b){var d=b[c];if(d.appStoreId===a||d.playStoreUid===a)return d.length}return null})},f}])}(angular),function(a){"use strict";a.module("znk.iap").provider("IapSrv",[function(){var b,c,d;this.registerProducts=function(a){b=a},this.setValidator=function(a){c=a},this.setNoStoreMode=function(a){d=a,console.log("IAP EnableNoStoreMode: "+d)},this.$get=["$window","$q","$injector","$filter","InAppPurchaseHelperSrv","ENV","$analytics","$ionicLoading","$ionicPopup","$document","$timeout",function(e,f,g,h,i,j,k,l,m,n,o){function p(b,c){for(var d in b)b.hasOwnProperty(d)&&(c&&"object"==typeof b[d]?p(b[d]):a.isUndefined(b[d])&&(console.log("property is undefined, property="+d),b[d]=null));return b}function q(){return A||(A=g.invoke(c)),A}function r(){return console.log("_getAppProducts"),g.invoke(b)}function s(){return console.log("init app products for the store"),r()}function t(){console.log("not online"),B=!1}function u(){console.log("online"),B=!0}var v=!e.cordova,w=f.defer(),x=w.promise,y=!1,z=o(function(){y=!0,a.isDefined(w)&&w.reject("store timeout")},1e4);(d||v)&&(y||(o.cancel(z),w.resolve()));var A,B=!(!e.navigator||!e.navigator.onLine),C={transaction:{id:"demo"},price:"$30.99",title:"buy"},D={initializedStore:!1,products:{},appProductsArr:[],isPurchaseInProgress:!1,purchaseInProgressDfd:void 0,IapErrorCodeEnum:{CANCELLED:0,FAILED:1,VALIDATOR_FALSE:2,VALIDATOR_ERROR:3,VALIDATOR_NO_TRANSACTION:4}};return D.getAppProduct=function(a){for(var b=0;b<D.appProductsArr.length;b++)if(D.appProductsArr[b].id===a)return D.appProductsArr[b]},D.getStoreProduct=function(a){return x.then(function(){return D.products[a]})},D.getStoreProducts=function(){return x.then(function(){var b=[];if(d||v)D.appProductsArr.forEach(function(c){var d={};C.title=c.id.replace("com.zinkerz.zinkerztoefl.",""),a.extend(d,c,C),b.push(a.copy(d))});else for(var c in D.products)b.push(a.copy(D.products[c]));return b})},D.getIapStoreReadyPromise=function(){return x},D.purchase=function(b){return x.then(function(){if(console.log("purchase: isPurchaseInProgress="+D.isPurchaseInProgress),D.isPurchaseInProgress)return console.log("purchase is already in progress"),f.when(!1);if(D.isPurchaseInProgress=!0,D.purchaseInProgressDfd=f.defer(),l.show({template:"Purchase is in progress..."}),d||v){var c=q(),g={},h=D.getAppProduct(b);return a.extend(g,h,C),c(g).then(function(a){a?(console.log("mock purchase completed"),D.purchaseInProgressDfd.resolve(h),D.isPurchaseInProgress=!1,l.hide(),console.log("purchase: isPurchaseInProgress="+D.isPurchaseInProgress)):(console.log("error in validating mock purchase"),D.purchaseInProgressDfd.reject(),D.isPurchaseInProgress=!1,l.hide(),console.log("purchase: isPurchaseInProgress="+D.isPurchaseInProgress))})["catch"](function(a){console.log("error in mock purchase, err: "+a),D.purchaseInProgressDfd.reject(a),D.isPurchaseInProgress=!1,l.hide(),console.log("purchase: isPurchaseInProgress="+D.isPurchaseInProgress)}),D.purchaseInProgressDfd.promise}var i=D.products[b];return i?e.store.order(i.id).error(function(a){console.log("error in purchase, store.order, err:"+a),D.purchaseInProgressDfd.reject(a),D.isPurchaseInProgress=!1,l.hide(),console.log("purchase: isPurchaseInProgress="+D.isPurchaseInProgress)}):(console.log("error in purchase, no product"),D.purchaseInProgressDfd.reject(),D.isPurchaseInProgress=!1,l.hide(),console.log("purchase: isPurchaseInProgress="+D.isPurchaseInProgress)),D.purchaseInProgressDfd.promise})},D.initStore=function(){if(d||v)return void s().then(function(b){a.isArray(b)&&b.length>0?(D.appProductsArr=b,console.log("app products loaded")):console.error("failed to load app products")})["catch"](function(a){console.error("failed to load app products, err:"+a)});if(!e.store)return console.log("store is not available"),void(a.isDefined(w)&&(y||w.reject()));console.log("initializing store");var b=s();b["catch"](function(b){console.error("failed to load app products, err:"+b),a.isDefined(w)&&(y||w.reject(b))}),b.then(function(b){if(!(a.isArray(b)&&b.length>0))return console.error("failed to load app products"),void(a.isDefined(w)&&(y||w.reject()));if(D.appProductsArr=b,console.log("app products loaded"),!D.initializedStore){D.initializedStore=!0,e.store.verbosity=e.store.QUIET,e.store.validator=function(b,c){if(console.log("performing validator"),b.transaction){console.log("new transaction, transaction:"+JSON.stringify(b.transaction));var d=q(),e=p(a.copy(b),!0);d(e).then(function(d){l.hide(),d?(a.isDefined(D.purchaseInProgressDfd)&&D.purchaseInProgressDfd.resolve(b),D.isPurchaseInProgress=!1,l.hide(),console.log("purchase: isPurchaseInProgress="+D.isPurchaseInProgress),c(!0,b)):(console.error("store validator returned false"),a.isDefined(D.purchaseInProgressDfd)&&D.purchaseInProgressDfd.reject(!1),D.isPurchaseInProgress=!1,l.hide(),console.log("purchase: isPurchaseInProgress="+D.isPurchaseInProgress),c(!1,{error:{code:D.IapErrorCodeEnum.VALIDATOR_FALSE,message:"store validator returned false"}}))})["catch"](function(b){console.error("error in store validator: "+b),a.isDefined(D.purchaseInProgressDfd)&&D.purchaseInProgressDfd.reject(b),D.isPurchaseInProgress=!1,l.hide(),console.log("purchase: isPurchaseInProgress="+D.isPurchaseInProgress),c(!1,{error:{code:D.IapErrorCodeEnum.VALIDATOR_ERROR,message:b}})})}else console.log("no transaction"),a.isDefined(D.purchaseInProgressDfd)&&D.purchaseInProgressDfd.reject(),D.isPurchaseInProgress=!1,l.hide(),console.log("purchase: isPurchaseInProgress="+D.isPurchaseInProgress),c(!1,{error:{code:D.IapErrorCodeEnum.VALIDATOR_NO_TRANSACTION,message:"no transaction"}})},D.appProductsArr.forEach(function(a){console.log("registering product: "+JSON.stringify(a)),e.store.register({id:a.id,alias:a.alias,type:a.type})});var c=function(a){console.log("purchase approved"),k.eventTrack("purchase-approved",{category:"purchase",label:"approved"}),a.verify()};D.appProductsArr.forEach(function(a){e.store.when(a.id).approved(function(a){c(a)})}),D.appProductsArr.forEach(function(a){e.store.when(a.id).verified(function(a){console.log("purchase verified"),a.finish()})}),D.appProductsArr.forEach(function(a){e.store.when(a.id).unverified(function(){console.log("purchase unverified")})}),D.appProductsArr.forEach(function(a){e.store.when(a.id).initiated(function(){console.log("purchase initiated...")})});var d=function(){console.log("purchase cancelled"),a.isDefined(D.purchaseInProgressDfd)&&D.purchaseInProgressDfd.reject({code:D.IapErrorCodeEnum.CANCELLED,message:"purchase cancelled"}),D.isPurchaseInProgress=!1,l.hide(),console.log("purchase: isPurchaseInProgress="+D.isPurchaseInProgress)};D.appProductsArr.forEach(function(a){e.store.when(a.id).cancelled(function(a){d(a)}),e.store.when(a.id).refunded(function(a){console.log("purchase refunded, product:"+a.id)})}),e.store.ready(function(){console.log("-----store is ready-----"),y||(o.cancel(z),a.isDefined(w)&&w.resolve())}),D.appProductsArr.forEach(function(a){e.store.when(a.id).updated(function(a){console.log("product updated: "+a.id),D.products[a.id]=a}),e.store.when(a.id).finished(function(a){console.log("product finished: "+a.id)})}),e.store.error(function(b){a.isDefined(D.purchaseInProgressDfd)&&D.purchaseInProgressDfd.reject(b),D.isPurchaseInProgress=!1,l.hide(),console.log("purchase: isPurchaseInProgress="+D.isPurchaseInProgress),a.isDefined(w)&&(y||w.reject(b)),console.log("store error "+b.code+": "+b.message)}),e.store.refresh()}})["catch"](function(b){a.isDefined(w)&&(y||w.reject(b)),console.error("failed to init store products, err="+b)})},document.addEventListener("offline",t,!1),document.addEventListener("online",u,!1),o(function(){D.initStore()},0),D}]}])}(angular);