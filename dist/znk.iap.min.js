!function(a){"use strict";a.module("znk.iap",["ionic"])}(angular),function(a){"use strict";a.module("znk.iap").factory("InAppPurchaseHelperSrv",["$q","$rootScope","$injector","ENV","$log",function(b,c,d,e,f){var g={},h="iap",i=e.firebaseAppScopeName;return g.getProducts=function(){var a=d.get("StorageSrv");return a.get(h).then(function(a){return a.products&&a.products[i]&&a.products[i].length?a.products[i]:(f.error("Failed to retrieve products from db"),b.reject("Failed to retrieve products from db"))})},g.getUserSubscription=function(){var a=d.get("StorageSrv"),b=a.globalUserSpacePath.concat(["subscriptions"]);return a.get(b).then(function(a){return a[i]?new Date(a[i]):null})},g.updateSubscription=function(b){if(!a.isUndefined(b)){var c=d.get("StorageSrv"),e=c.globalUserSpacePath.concat(["subscriptions"]);return c.get(e).then(function(a){a[i]=b.getTime(),c.set(e,a)})}},g.validateReceipt=function(){return b.when(!0)},g.addTransaction=function(c){var e=c.transaction.id?c.transaction.id.replace(".",""):(new Date).getTime();for(var f in c.transaction)(a.isUndefined(c.transaction[f])||null===c.transaction[f])&&delete c.transaction[f];c.purchaseTime=(new Date).getTime();var h=d.get("StorageSrv"),i=h.globalUserSpacePath.concat(["transactions"]);return h.get(i).then(function(a){if(a[e])return b.when(null);a[e]=c,h.set(i,a);var d=g.getProductLength(c.id);return d.then(function(a){if(!a)return null;var b=new Date;return b.setMonth(b.getMonth()+a),g.updateSubscription(b),b})})},g.getProductLength=function(a){var b=g.getProducts();return b.then(function(b){for(var c in b){var d=b[c];if(d.appStoreId===a||d.playStoreUid===a)return d.length}return null})},g}])}(angular),function(a){"use strict";a.module("znk.iap").provider("IapSrv",["$logProvider",function(b){var c,d,e,f,g=!1,h=!1,i="182516";b.debugEnabled(h);var j=a.injector(["ng"]).get("$log");this.registerProducts=function(a){c=a},this.setAdvertiserRefId=function(a){a=a},this.enableDebug=function(a){h=a,b.debugEnabled(h)},this.setValidator=function(a){d=a},this.setNoStoreMode=function(a){e=a,j.debug("IAP EnableNoStoreMode: "+e)},this.setEnableRecipetValidation=function(a){g=a},this.setValidationUrl=function(a){f=a},this.$get=["$window","$q","$injector","$filter","InAppPurchaseHelperSrv","ENV","$analytics","$ionicLoading","$ionicPopup","$document","$timeout","$http",function(b,h,k,l,m,n,o,p,q,r,s,t){function u(a){var b,c=y(a.type);if(c===J.UNKNOWN)return h.reject("unknown platform");switch(c){case"apple":b={appleReceipt:a.appStoreReceipt};break;case"google":b={signature:a.signature,receiptData:a.receipt}}return t.post(f+"verify/"+c,{transaction:a}).then(function(a){return a},function(a){return h.reject(a)})}function v(){return G||(G=k.invoke(d)),G}function w(){return j.debug("_getAppProducts"),k.invoke(c)}function x(){return j.debug("init app products for the store"),w()}function y(b){switch(a.lowercase(b)){case"ios-appstore":return"apple";case"android-playstore":return"google";default:return J.UNKNOWN}}function z(){j.debug("not online"),H=!1}function A(){j.debug("online"),H=!0}var B=!b.cordova,C=h.defer(),D=C.promise,E=!1,F=s(function(){E=!0,a.isDefined(C)&&C.reject("store timeout")},15e3);(e||B)&&(E||(s.cancel(F),C.resolve()));var G,H=!(!b.navigator||!b.navigator.onLine),I={transaction:{id:"demo"},price:"$30.99",title:"buy"},J={IOS:0,ANDROID:1,UNKNOWN:2},K={initializedStore:!1,products:{},appProductsArr:[],isPurchaseInProgress:!1,purchaseInProgressDfd:void 0,IapErrorCodeEnum:{CANCELLED:0,FAILED:1,VALIDATOR_FALSE:2,VALIDATOR_ERROR:3,VALIDATOR_NO_TRANSACTION:4,RECIPT_NOT_APPROVED:5}};return K.getAppProduct=function(a){for(var b=0;b<K.appProductsArr.length;b++)if(K.appProductsArr[b].id===a)return K.appProductsArr[b]},K.getStoreProduct=function(a){return D.then(function(){return K.products[a]})},K.getStoreProducts=function(){return D.then(function(){var b=[];if(e||B)K.appProductsArr.forEach(function(c){var d={};I.title=c.id.replace("com.zinkerz.zinkerztoefl.",""),a.extend(d,c,I),b.push(a.copy(d))});else for(var c in K.products)b.push(a.copy(K.products[c]));return b})},K.getIapStoreReadyPromise=function(){return D},K.purchase=function(c){return j.debug("starting purchase"),D.then(function(){if(j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress),K.isPurchaseInProgress)return j.debug("purchase is already in progress"),h.reject(!1);if(K.isPurchaseInProgress=!0,K.purchaseInProgressDfd=h.defer(),p.show({template:"Purchase is in progress..."}),e||B){var d=v(),f={},g=K.getAppProduct(c);return a.extend(f,g,I),d(f).then(function(a){a?(j.debug("mock purchase completed"),K.purchaseInProgressDfd.resolve(g),K.isPurchaseInProgress=!1,p.hide(),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress)):(j.debug("error in validating mock purchase"),K.purchaseInProgressDfd.reject(),K.isPurchaseInProgress=!1,p.hide(),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress))})["catch"](function(a){j.debug("error in mock purchase, err: "+a),K.purchaseInProgressDfd.reject(a),K.isPurchaseInProgress=!1,p.hide(),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress)}),K.purchaseInProgressDfd.promise}var i=K.products[c];return i?b.store.order(i.id).error(function(a){j.debug("error in purchase, store.order, err:"+a),o.eventTrack("store-order-error",{category:"purchase",label:a}),K.purchaseInProgressDfd.reject(a),K.isPurchaseInProgress=!1,p.hide(),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress)}):(j.debug("error in purchase, no product"),K.purchaseInProgressDfd.reject(),K.isPurchaseInProgress=!1,p.hide(),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress)),K.purchaseInProgressDfd.promise})},K.initStore=function(){if(e||B)return void x().then(function(b){a.isArray(b)&&b.length>0?(K.appProductsArr=b,j.debug("app products loaded")):j.error("failed to load app products")})["catch"](function(a){j.error("failed to load app products, err:"+a)});if(!b.store)return j.debug("store is not available"),void(a.isDefined(C)&&(E||C.reject()));j.debug("initializing store"),g&&(a.isString(f)&&0!==f.length||E||C.reject());var c=x();c["catch"](function(b){j.error("failed to load app products, err:"+b),a.isDefined(C)&&(E||C.reject(b))}),c.then(function(c){if(!(a.isArray(c)&&c.length>0))return j.error("failed to load app products"),void(a.isDefined(C)&&(E||C.reject()));if(K.appProductsArr=c,j.debug("app products loaded"),!K.initializedStore){K.initializedStore=!0,b.store.verbosity=n.debug?b.store.DEBUG:b.store.QUIET,b.store.validator=function(a,c){if(j.debug("performing validator"),a.type===b.store.PAID_SUBSCRIPTION&&a.owned)return void c(!1,{code:b.store.PURCHASE_EXPIRED,error:{code:K.IapErrorCodeEnum.RECIPT_NOT_APPROVED,message:"subscription already owned"}});var d;a.transaction?(j.debug("new transaction, transaction:"+JSON.stringify(a.transaction)),g?(j.debug("enableRecipetValidation is true"),d=u(a.transaction)):d=h.when(!0),d.then(function(d){j.debug("verifyRecieptProm returned "+d),d&&d.data&&d.data.ok?c(!0,d.data.data):a.type===b.store.PAID_SUBSCRIPTION?c(!1,{code:b.store.PURCHASE_EXPIRED,error:{code:K.IapErrorCodeEnum.RECIPT_NOT_APPROVED,message:"recipt not approved"}}):c(!1,{error:{code:K.IapErrorCodeEnum.RECIPT_NOT_APPROVED,message:"recipt not approved"}})})["catch"](function(d){j.error("error in verifyRecieptProm validator: "+d),a.type===b.store.PAID_SUBSCRIPTION?c(!1,{code:b.store.PURCHASE_EXPIRED,error:{code:K.IapErrorCodeEnum.RECIPT_NOT_APPROVED,message:"recipt not approved"}}):c(!1,{error:{code:K.IapErrorCodeEnum.RECIPT_NOT_APPROVED,message:"recipt not approved"}})})):(j.debug("no transaction in validator"),a.type===b.store.PAID_SUBSCRIPTION?c(!1,{code:b.store.PURCHASE_EXPIRED,error:{code:K.IapErrorCodeEnum.VALIDATOR_NO_TRANSACTION,message:"no transaction in validator"}}):c(!1,{error:{code:K.IapErrorCodeEnum.VALIDATOR_NO_TRANSACTION,message:"no transaction in validator"}}))},K.appProductsArr.forEach(function(a){j.debug("registering product: "+JSON.stringify(a)),b.store.register({id:a.id,alias:a.alias,type:a.type})});var d=function(a){j.debug("purchase approved"),o.eventTrack("purchase-approved",{category:"purchase",label:"approved"}),a.verify()};K.appProductsArr.forEach(function(a){b.store.when(a.id).approved(function(a){d(a)}),b.store.when(b.store.PAID_SUBSCRIPTION).updated(function(a){j.debug("---------- proudctId:"+a.id+",owned:"+a.owned)})}),K.appProductsArr.forEach(function(c){b.store.when(c.id).verified(function(b){j.debug("purchase verified"),o.eventTrack("purchase-recipt-verified",{category:"purchase",label:"verified"});var c=v();a.isFunction(c)?c(b).then(function(c){p.hide(),c?(j.debug("app validator returned true"),a.isDefined(K.purchaseInProgressDfd)&&K.purchaseInProgressDfd.resolve(b),K.isPurchaseInProgress=!1,p.hide(),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress),b.finish()):(j.error("app validator returned false"),a.isDefined(K.purchaseInProgressDfd)&&K.purchaseInProgressDfd.reject(!1),K.isPurchaseInProgress=!1,p.hide(),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress))})["catch"](function(b){j.error("error in app validator: "+b),o.eventTrack("store-validator-error",{category:"purchase",label:b}),a.isDefined(K.purchaseInProgressDfd)&&K.purchaseInProgressDfd.reject(b),K.isPurchaseInProgress=!1,p.hide(),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress)}):(j.error("_getValidatorFunc returned no function"),a.isDefined(K.purchaseInProgressDfd)&&K.purchaseInProgressDfd.reject(!1),K.isPurchaseInProgress=!1,p.hide(),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress))})}),K.appProductsArr.forEach(function(c){b.store.when(c.id).unverified(function(){j.debug("purchase unverified"),o.eventTrack("purchase-unverified",{category:"purchase",label:"unverified"}),j.error("store recipt no validated"),a.isDefined(K.purchaseInProgressDfd)&&K.purchaseInProgressDfd.reject(),K.isPurchaseInProgress=!1,p.hide(),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress)})}),K.appProductsArr.forEach(function(a){b.store.when(a.id).initiated(function(){j.debug("purchase initiated...")})});var e=function(){j.debug("purchase cancelled"),o.eventTrack("cancel-purchase",{category:"purchase",label:"cancelled"}),a.isDefined(K.purchaseInProgressDfd)&&K.purchaseInProgressDfd.reject({code:K.IapErrorCodeEnum.CANCELLED,message:"purchase cancelled"}),K.isPurchaseInProgress=!1,p.hide(),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress)};K.appProductsArr.forEach(function(a){b.store.when(a.id).cancelled(function(a){e(a)}),b.store.when(a.id).refunded(function(a){j.debug("purchase refunded, product:"+a.id)})}),b.store.ready(function(){j.debug("-----store is ready-----"),E||(s.cancel(F),a.isDefined(C)&&C.resolve())}),K.appProductsArr.forEach(function(a){b.store.when(a.id).updated(function(a){j.debug("product updated: "+a.id),K.products[a.id]=a}),b.store.when(a.id).finished(function(a){j.debug("product finished: "+a.id),o.eventTrack("purchased",{category:"purchase",label:a.id}),o.pageTrack("product-purchased/"+a.id),b.plugins&&b.plugins.matPlugin&&b.plugins.matPlugin.measureEvent({name:"purchased",revenue:1,currency:"USD",advertiserRefId:i,eventItems:[{item:a.id,quantity:1}]})})}),b.store.error(function(b){j.debug("store-error "+b.code+": "+b.message),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress),o.eventTrack("store-error",{category:"purchase",label:b}),a.isDefined(K.purchaseInProgressDfd)&&K.purchaseInProgressDfd.reject(b),K.isPurchaseInProgress=!1,p.hide(),j.debug("purchase: isPurchaseInProgress="+K.isPurchaseInProgress),a.isDefined(C)&&(E||C.reject(b))}),b.store.refresh()}})["catch"](function(b){a.isDefined(C)&&(E||C.reject(b)),j.error("failed to init store products, err="+b)})},document.addEventListener("offline",z,!1),document.addEventListener("online",A,!1),s(function(){K.initStore()},0),K}]}])}(angular);