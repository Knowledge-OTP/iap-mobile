!function(a){"use strict";a.module("znk.iap",["ionic"])}(angular),function(a){"use strict";a.module("znk.iap").factory("InAppPurchaseHelperSrv",["$q","$rootScope","$injector","ENV",function(b,c,d,e){var f={},g="iap",h=e.firebaseAppScopeName;return f.getProducts=function(){var a=d.get("StorageSrv");return a.get(g).then(function(a){return a.products&&a.products[h]&&a.products[h].length?a.products[h]:(console.error("Failed to retrieve products from db"),b.reject("Failed to retrieve products from db"))})},f.canUpgrade=function(){return!0},f.getUserSubscription=function(){var a=d.get("StorageSrv"),b=a.globalUserSpacePath.concat(["subscriptions"]);return a.get(b).then(function(a){return a[h]?new Date(a[h]):null})},f.updateSubscription=function(b){if(!a.isUndefined(b)){var c=d.get("StorageSrv"),e=c.globalUserSpacePath.concat(["subscriptions"]);return c.get(e).then(function(a){a[h]=b.getTime(),c.set(e,a)})}},f.validateReceipt=function(){return b.when(!0)},f.addTransaction=function(c){var e=c.transaction.id?c.transaction.id.replace(".",""):(new Date).getTime();for(var g in c.transaction)(a.isUndefined(c.transaction[g])||null===c.transaction[g])&&delete c.transaction[g];c.purchaseTime=(new Date).getTime();var h=d.get("StorageSrv"),i=h.globalUserSpacePath.concat(["transactions"]);return h.get(i).then(function(a){if(a[e])return b.when(null);a[e]=c,h.set(i,a);var d=f.getProductLength(c.id);return d.then(function(a){if(!a)return null;var b=new Date;return b.setMonth(b.getMonth()+a),f.updateSubscription(b),b})})},f.getProductLength=function(a){var b=f.getProducts();return b.then(function(b){for(var c in b){var d=b[c];if(d.appStoreId===a||d.playStoreUid===a)return d.length}return null})},f}])}(angular),function(a){"use strict";a.module("znk.iap").provider("IapSrv",[function(){var b,c,d,e;this.setProductsFallback=function(a){d=a},this.registerProducts=function(a){b=a},this.setValidator=function(a){c=a},this.setNoStoreMode=function(a){e=a,console.log("IAP EnableNoStoreMode: "+e)},this.$get=["$window","$q","$injector","$filter","InAppPurchaseHelperSrv","ENV","$analytics","$ionicLoading","$ionicPopup","$document","$timeout",function(d,f,g,h,i,j,k,l,m,n,o){function p(){return w||(w=g.invoke(c)),w}function q(){return console.log("_getAppProducts"),g.invoke(b)}function r(){return console.log("init app products for the store"),q()}function s(){console.log("not online"),y=!1}function t(){console.log("online"),y=!0}var u=f.defer(),v=u.promise;e===!0&&u.resolve();var w,x=[],y=!(!d.navigator||!d.navigator.onLine),z=!d.cordova,A=0,B={transaction:{id:"demo"},price:"$30.99",title:"buy"},C={initializedStore:!1,products:{},appProductsArr:[],loadingError:!1,isShowingModal:!1,currentErrorPopup:void 0,isPurchasing:!1,purchaseInProgressProm:void 0,IapErrorCodeEnum:{CANCELLED:0,FAILED:1,VALIDATOR_FALSE:2,VALIDATOR_ERROR:3}};return C.getAppProduct=function(a){for(var b=0;b<C.appProductsArr.length;b++)if(C.appProductsArr[b].id===a)return C.appProductsArr[b]},C.getStoreProduct=function(a){return v.then(function(){return C.products[a]})},C.getStoreProducts=function(){return v.then(function(){var b=[];if(e||z)C.appProductsArr.forEach(function(c){var d={};B.title=c.id.replace("com.zinkerz.zinkerztoefl.",""),a.extend(d,c,B),b.push(a.copy(d))});else for(var c in C.products)b.push(a.copy(C.products[c]));return b})},C.getIapStoreReadyPromise=function(){return v},C.purchase=function(b){return v.then(function(){if(C.purchaseInProgressProm=f.defer(),e||z){var c=p(),g={},h=C.getAppProduct(b);return a.extend(g,h,B),c(g).then(function(a){a?(console.log("mock purchase completed"),C.purchaseInProgressProm.resolve(h)):(console.log("error in validating purchase"),C.purchaseInProgressProm.reject())})["catch"](function(a){console.log("error in purchase, err: "+a),C.purchaseInProgressProm.reject(a)}),C.purchaseInProgressProm.promise}C.isShowingModal=!0;var i=C.products[b];return i?(C.isPurchasing=!0,d.store.order(i.id).error(function(a){console.log("error in purchase"),C.purchaseInProgressProm&&C.purchaseInProgressProm.reject(a),l.hide(),C.currentErrorPopup&&C.currentErrorPopup.close(),C.currentErrorPopup.then(function(){C.currentErrorPopup=void 0})})):(C.currentErrorPopup&&C.currentErrorPopup.close(),C.currentErrorPopup.then(function(){C.currentErrorPopup=void 0,C.purchaseInProgressProm.reject()})),C.purchaseInProgressProm.promise})},C.initStore=function(){if(e||z)return void r().then(function(b){a.isArray(b)&&b.length>0?(C.appProductsArr=b,console.log("app products loaded")):console.error("failed to load app products")})["catch"](function(a){console.error("failed to load app products, err:"+a)});if(!d.store)return console.log("store is not available"),void(C.loadingError=!0);console.log("initializing store");var b=r();b["catch"](function(a){console.error("failed to load app products, err:"+a),C.loadingError=!0}),b.then(function(b){if(!(a.isArray(b)&&b.length>0))return void console.error("failed to load app products");if(C.appProductsArr=b,console.log("app products loaded"),A=b.length,!C.initializedStore){C.initializedStore=!0,d.store.verbosity=d.store.QUIET,d.store.validator=function(a,b){if(console.log("validator"),i.canUpgrade()&&a.transaction){console.log("validator and transaction:"+JSON.stringify(a.transaction));var c=p();c(a).then(function(c){l.hide(),c?(C.purchaseInProgressProm.resolve(a),b(!0,a)):(console.error("store validator returned false"),C.purchaseInProgressProm.reject(!1),b(!1,{error:{code:C.IapErrorCodeEnum.VALIDATOR_FALSE,message:"store validator returned false"}}))})["catch"](function(a){console.error("error in store validator: "+a),C.purchaseInProgressProm.reject(a),b(!1,{error:{code:C.IapErrorCodeEnum.VALIDATOR_ERROR,message:a}})})}},C.appProductsArr.forEach(function(a){console.log("registering product: "+JSON.stringify(a)),d.store.register({id:a.id,alias:a.alias,type:a.type})});var c=function(a){console.log("purchase approved"),k.eventTrack("purchase-approved",{category:"purchase",label:"approved"}),a.verify()};C.appProductsArr.forEach(function(a){d.store.when(a.id).approved(function(a){c(a)})}),C.appProductsArr.forEach(function(a){d.store.when(a.id).verified(function(a){console.log("purchase verified"),a.finish()})}),C.appProductsArr.forEach(function(a){d.store.when(a.id).unverified(function(){console.log("purchase unverified")})});var e=function(){l.show({template:"Purchase is in progress..."}),console.log("Purchase is in progress...")};C.appProductsArr.forEach(function(a){d.store.when(a.id).initiated(function(){e()})});var g=function(){l.hide(),console.log("purchase cancelled"),C.purchaseInProgressProm&&C.purchaseInProgressProm.reject({code:C.IapErrorCodeEnum.CANCELLED,message:"purchase cancelled"})};C.appProductsArr.forEach(function(a){d.store.when(a.id).cancelled(function(a){g(a)}),d.store.when(a.id).refunded(function(a){console.log("purchase refunded, product:"+a.id)})}),C.appProductsArr.forEach(function(a){d.store.when(a.id).updated(function(a){console.log("product updated: "+a.id),C.products[a.id]=a}),d.store.when(a.id).finished(function(a){console.log("product finished: "+a.id)}),d.store.when(a.id).registered(function(a){console.log("product registered: "+a.id),x.push(f.when(a.id)),x.length===A&&u.resolve()})}),d.store.error(function(a){l.hide(),C.purchaseInProgressProm&&C.purchaseInProgressProm.reject(a),console.log("store error "+a.code+": "+a.message),console.log("isShowingModal: "+C.isShowingModal),a.code!==d.store.ERR_PURCHASE&&C.isShowingModal&&(C.loadingError=!0,C.currentErrorPopup||(C.currentErrorPopup=m.alert({title:"Error",template:"There was an error with the store. Please try again later.",okText:"OK",okType:"button-default"}),C.currentErrorPopup.then(function(){C.currentErrorPopup=void 0}))),a.code&&C.isShowingModal&&(C.loadingError=!0,C.currentErrorPopup||(C.currentErrorPopup=m.alert({title:"Error",template:"There was an error with the store. Please try again later.",okText:"OK",okType:"button-default"}),C.currentErrorPopup.then(function(){C.currentErrorPopup=void 0})))}),i.canUpgrade()&&d.store.refresh()}})["catch"](function(a){console.error("failed to init store products, err="+a)})},document.addEventListener("offline",s,!1),document.addEventListener("online",t,!1),o(function(){C.initStore()},0),C}]}])}(angular);