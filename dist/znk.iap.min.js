!function(a){"use strict";a.module("znk.iap",["ionic"])}(angular),function(a){"use strict";a.module("znk.iap").factory("InAppPurchaseHelperSrv",["$q","$rootScope","$injector","ENV",function(b,c,d,e){var f={},g="iap",h=e.firebaseAppScopeName;return f.getProducts=function(){var a=d.get("StorageSrv");return a.get(g).then(function(a){return a.products&&a.products[h]&&a.products[h].length?a.products[h]:(console.error("Failed to retrieve products from db"),b.reject("Failed to retrieve products from db"))})},f.getUserSubscription=function(){var a=d.get("StorageSrv"),b=a.globalUserSpacePath.concat(["subscriptions"]);return a.get(b).then(function(a){return a[h]?new Date(a[h]):null})},f.updateSubscription=function(b){if(!a.isUndefined(b)){var c=d.get("StorageSrv"),e=c.globalUserSpacePath.concat(["subscriptions"]);return c.get(e).then(function(a){a[h]=b.getTime(),c.set(e,a)})}},f.validateReceipt=function(){return b.when(!0)},f.addTransaction=function(c){var e=c.transaction.id?c.transaction.id.replace(".",""):(new Date).getTime();for(var g in c.transaction)(a.isUndefined(c.transaction[g])||null===c.transaction[g])&&delete c.transaction[g];c.purchaseTime=(new Date).getTime();var h=d.get("StorageSrv"),i=h.globalUserSpacePath.concat(["transactions"]);return h.get(i).then(function(a){if(a[e])return b.when(null);a[e]=c,h.set(i,a);var d=f.getProductLength(c.id);return d.then(function(a){if(!a)return null;var b=new Date;return b.setMonth(b.getMonth()+a),f.updateSubscription(b),b})})},f.getProductLength=function(a){var b=f.getProducts();return b.then(function(b){for(var c in b){var d=b[c];if(d.appStoreId===a||d.playStoreUid===a)return d.length}return null})},f}])}(angular),function(a){"use strict";a.module("znk.iap").provider("IapSrv",[function(){var a,b,c;this.setProductsFallback=function(a){c=a},this.registerProducts=function(b){a=b},this.setValidator=function(a){b=a},this.$get=["$window","$q","$injector","$rootScope","$filter","InAppPurchaseHelperSrv","ENV","$analytics","$ionicLoading","$ionicPopup","$document","$timeout",function(c,d,e,f,g,h,i,j,k,l,m,n){function o(){return console.log("_getStoreProducts"),e.invoke(a)}function p(){return t||(t=e.invoke(b)),t}function q(){return console.log("idgit statnit store products"),o()}function r(){console.log("not online"),u=!1}function s(){console.log("online"),u=!0}var t,u=!(!c.navigator||!c.navigator.onLine),v="iap:purchased",w="iap:productUpdated",x={initializedStore:!1,products:{},appProductsArr:[],loadingError:!1,isShowingModal:!1,currentErrorPopup:void 0,isPurchasing:!1,purchaseInProgressProm:void 0};return x.isStoreLoaded=function(){return x.products[x.appProductsArr[0].id]||x.isLoadingError()},x.isLoadingError=function(){return x.loadingError},x.getProducts=function(){if(!u)return d.reject("No Internet connection");if(!x.isStoreLoaded)return d.reject("store not loaded");var a=[];return x.appProductsArr.forEach(function(b){a.push(x.products[b.id])}),d.when(a)},x.purchase=function(a){x.purchaseInProgressProm=d.defer(),x.isShowingModal=!0;var b=x.products[a];return b?(x.isPurchasing=!0,c.store.order(b.id).error(function(a){console.log("error in purchase"),x.purchaseInProgressProm&&x.purchaseInProgressProm.reject(a),k.hide(),x.currentErrorPopup&&x.currentErrorPopup.close(),x.currentErrorPopup=l.alert({title:"Error",template:"There was an error with the purchase",okText:"OK",okType:"button-default"}),x.currentErrorPopup.then(function(){x.currentErrorPopup=void 0})})):(x.currentErrorPopup&&x.currentErrorPopup.close(),x.currentErrorPopup=l.alert({title:"Error",template:"There was an error with the product",okText:"OK",okType:"button-default"}),x.currentErrorPopup.then(function(){x.currentErrorPopup=void 0,x.purchaseInProgressProm.reject()})),x.purchaseInProgressProm.promise},x.refreshStore=function(){h.canUpgrade()?(console.log("refresh store initiated"),x.initializedStore?c.store.refresh():x.initStore()):console.log("user cannot upgrade at this time")},x.initStore=function(){if(!c.store)return console.log("store is not available"),void(x.loadingError=!0);console.log("initializing store");var a=f.$new(!0);a.$on(v,function(a){console.log("purchased event, productId: "+a),x.isShowingModal&&(k.show({template:"Thank you for your purchase !!!"}),n(function(){k.hide()},4e3))});var b=q();b["catch"](function(){x.loadingError=!0}),b.then(function(a){if(x.appProductsArr=a,console.log("app products loaded"),!x.initializedStore){x.initializedStore=!0,c.store.verbosity=c.store.QUIET,c.store.validator=function(a,b){if(console.log("validator"),h.canUpgrade()&&a.transaction){console.log("validator and transaction:"+JSON.stringify(a.transaction)),k.hide();var c=p();c(a).then(function(a){b(!0,{}),x.isShowingModal&&(k.show({template:"purchase verified"}),n(function(){k.hide()},2e3)),f.$broadcast(v,a.id)})["catch"](function(a){console.log("error: "+a)})}},x.appProductsArr.forEach(function(a){console.log("registering product: "+JSON.stringify(a)),c.store.register({id:a.id,alias:a.alias,type:a.type})});var b=function(a){x.isShowingModal&&k.show({template:"Purchase approved, validating..."}),console.log("purchase approved"),j.eventTrack("purchase-approved",{category:"purchase",label:"approved"}),a.verify()};x.appProductsArr.forEach(function(a){c.store.when(a.id).approved(function(a){b(a)})}),x.appProductsArr.forEach(function(a){c.store.when(a.id).verified(function(a){console.log("purchase verified"),a.finish()})}),x.appProductsArr.forEach(function(a){c.store.when(a.id).unverified(function(){console.log("purchase unverified")})});var d=function(){k.show({template:"Initiating purchase..."}),console.log("purchase initiated")};x.appProductsArr.forEach(function(a){c.store.when(a.id).initiated(function(){d()})});var e=function(){k.hide(),console.log("purchase cancelled"),l.alert({title:"Error",template:"Your purhcase has been cancelled",okText:"Got it",okType:"button-default"}),x.purchaseInProgressProm&&x.purchaseInProgressProm.reject()};x.appProductsArr.forEach(function(a){c.store.when(a.id).cancelled(function(a){e(a)})}),x.appProductsArr.forEach(function(a){c.store.when(a.id).updated(function(a){console.log("product updated: "+a.id),x.products[a.id]=a,f.$broadcast(w)})}),c.store.error(function(a){x.purchaseInProgressProm&&x.purchaseInProgressProm.reject(a),k.hide(),console.log("store error "+a.code+": "+a.message),console.log("isShowingModal: "+x.isShowingModal),a.code!==c.store.ERR_PURCHASE&&x.isShowingModal&&(x.loadingError=!0,x.currentErrorPopup||(x.currentErrorPopup=l.alert({title:"Error",template:"There was an error with the store. Please try again later.",okText:"OK",okType:"button-default"}),x.currentErrorPopup.then(function(){x.currentErrorPopup=void 0}))),a.code&&x.isShowingModal&&(x.loadingError=!0,x.currentErrorPopup||(x.currentErrorPopup=l.alert({title:"Error",template:"There was an error with the store. Please try again later.",okText:"OK",okType:"button-default"}),x.currentErrorPopup.then(function(){x.currentErrorPopup=void 0})))}),h.canUpgrade()&&c.store.refresh()}})["catch"](function(a){console.error("failed to init store products, err="+a)})},x.noStore=function(a){a||(a="No store available")},document.addEventListener("offline",r,!1),document.addEventListener("online",s,!1),x}]}])}(angular);